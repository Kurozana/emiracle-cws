---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import GemIcon from '../components/GemIcon.astro';
import skillsData from '../data/skills.json';
import { type SkillsData, type SkillTag, getStructuredTags, hasTag } from '../utils/skills';

// Ensure base URL ends with a slash
const baseRaw = import.meta.env.BASE_URL;
const base = baseRaw.endsWith('/') ? baseRaw : `${baseRaw}/`;
const data = skillsData as SkillsData;
const { loadouts, skillSetups, skills } = data;

// Helper to get skill props - passes structured data, no string building
function getSkillProps(skillId: string) {
  const skill = skills[skillId];
  if (!skill) return null;
  // Prepend base URL to icon path
  const iconPath = skill.icon ? `${base}${skill.icon.replace(/^\//, '')}` : undefined;
  // Get only structured tags for animated text effects
  const structuredTags = getStructuredTags(skill.tags);
  // Check if skill has "main" tag for border styling
  const isMain = hasTag(skill, 'main');
  return {
    baseName: skill.baseName,
    tags: structuredTags,
    color: skill.color,
    isSupport: skill.isSupport,
    icon: iconPath,
    level: skill.level,
    levelWarning: skill.levelWarning,
    isMain
  };
}
---

<BaseLayout title="Skill Gems">
  <Navigation slot="header" />

  <section class="page-header">
    <div class="container">
      <h1>Skill Gems</h1>
      <p class="text-muted">
        Gem links, support priorities, and alternative setups
      </p>
    </div>
  </section>

  <section class="skills-content section">
    <div class="container">

      <!-- Loadout Selector -->
      <div class="loadout-selector">
        <h3 class="loadout-title">Loadout</h3>
        <div class="loadout-tabs" id="loadout-tabs">
          {Object.entries(loadouts).map(([key, loadout], index) => (
            <button
              class:list={[
                'loadout-tab',
                { 'loadout-tab--active': index === 0 },
                { 'loadout-tab--limited-event': loadout.isLimitedEvent }
              ]}
              data-loadout={key}
              title={loadout.description}
            >
              {loadout.name}
            </button>
          ))}
        </div>
        <p class="loadout-description" id="loadout-description">
          {Object.values(loadouts)[0]?.description}
        </p>
      </div>

      {Object.entries(skillSetups).map(([key, setup]) => {
        const isLinked = setup.isLinked;
        return (
          <div class="skill-section" data-setup-id={key}>
            <h2>{setup.title}</h2>
            <p class="section-desc">{setup.description}</p>

            <div class:list={['gem-setup', { 'gem-setup--6link': isLinked }]}>
              {setup.rows.map((row, rowIndex) => (
                <div class="gem-row">
                  {row.map((item, itemIndex) => {
                    const skillProps = getSkillProps(item.skillId);
                    if (!skillProps) return null;

                    return (
                      <>
                        {isLinked && itemIndex > 0 && (
                          <span class="link-indicator">───</span>
                        )}
                        <GemIcon
                          baseName={skillProps.baseName}
                          tags={skillProps.tags}
                          color={skillProps.color}
                          size="md"
                          isSupport={skillProps.isSupport}
                          icon={skillProps.icon}
                          level={skillProps.level}
                          levelWarning={skillProps.levelWarning}
                          isMain={skillProps.isMain}
                        />
                      </>
                    );
                  })}
                </div>
              ))}
            </div>

          </div>
        );
      })}

    </div>
  </section>
</BaseLayout>

<style>
  .loadout-selector {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.25s ease;
  }

  .loadout-title {
    font-size: 1rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .loadout-tabs {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-sm);
  }

  .loadout-tab {
    padding: 0.6rem 1.2rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text-muted);
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .loadout-tab:hover {
    border-color: var(--color-accent);
    color: var(--color-text);
  }

  .loadout-tab--active {
    background: var(--color-accent-glow);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  /* Limited Event loadout - Modern minimalist green effect */
  .loadout-tab--limited-event {
    position: relative;
    background: linear-gradient(135deg, rgba(34, 139, 34, 0.08), rgba(0, 128, 0, 0.12));
    border-color: rgba(34, 139, 34, 0.4);
    transition: all 0.3s ease;
  }

  .loadout-tab--limited-event::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      135deg,
      transparent 0%,
      rgba(34, 139, 34, 0.15) 50%,
      transparent 100%
    );
    opacity: 0;
    animation: minimal-shimmer 3s ease-in-out infinite;
  }

  @keyframes minimal-shimmer {
    0%, 100% {
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
  }

  .loadout-tab--limited-event:hover {
    border-color: rgba(34, 139, 34, 0.7);
    background: linear-gradient(135deg, rgba(34, 139, 34, 0.12), rgba(0, 128, 0, 0.18));
    box-shadow: 0 0 12px rgba(34, 139, 34, 0.2);
  }

  .loadout-tab--limited-event.loadout-tab--active {
    border-color: #228b22;
    background: linear-gradient(135deg, rgba(34, 139, 34, 0.15), rgba(0, 128, 0, 0.22));
    color: #3cb371;
    box-shadow: 0 0 16px rgba(34, 139, 34, 0.25), inset 0 0 20px rgba(34, 139, 34, 0.1);
  }

  .loadout-tab--limited-event.loadout-tab--active::after {
    animation: minimal-shimmer 2.5s ease-in-out infinite;
  }

  .loadout-description {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-style: italic;
    margin: 0;
  }

  .page-header {
    padding: var(--spacing-xl) 0;
    background: var(--color-bg-secondary);
    text-align: center;
    transition: background-color var(--transition-theme);
  }

  .page-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .skills-content {
    padding-bottom: var(--spacing-xl);
  }

  .skill-section {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.25s ease;
  }

  .skill-section:hover {
    border-color: var(--color-border-hover);
    box-shadow: var(--shadow-md);
  }

  .skill-section h2 {
    margin-bottom: var(--spacing-xs);
    font-size: 1.25rem;
  }

  .section-desc {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: var(--spacing-lg);
  }

  .gem-setup {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .gem-setup--6link {
    background: var(--color-bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    border: 1px dashed var(--color-border);
  }

  .gem-row {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  /* Aura-specific layout - consistent icon sizing */
  .gem-setup:not(.gem-setup--6link) .gem-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 100px));
    justify-content: center;
    gap: var(--spacing-lg);
  }

  .link-indicator {
    color: var(--color-text-subtle);
    font-size: 0.9rem;
    font-weight: 400;
    letter-spacing: -2px;
    opacity: 0.6;
    user-select: none;
  }

  @media (max-width: 600px) {
    .gem-row {
      gap: var(--spacing-sm);
    }

    .link-indicator {
      display: none;
    }
  }
</style>

<script define:vars={{ loadouts }}>
  // Loadout System with localStorage persistence
  const STORAGE_KEY = 'emiracle-cws-loadout';

  function updateSkillSections(loadoutKey) {
    const activeSetups = loadouts[loadoutKey]?.activeSetups || [];
    const sections = document.querySelectorAll('.skill-section');

    sections.forEach(section => {
      const setupId = section.getAttribute('data-setup-id');
      if (activeSetups.includes(setupId)) {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    });
  }

  function initLoadoutSystem() {
    const tabs = document.querySelectorAll('.loadout-tab');
    const description = document.getElementById('loadout-description');

    // Load saved loadout from localStorage
    const savedLoadout = localStorage.getItem(STORAGE_KEY) || 'default';

    // Set initial active state and show correct sections
    tabs.forEach(tab => {
      const loadoutKey = tab.getAttribute('data-loadout');
      if (loadoutKey === savedLoadout) {
        tab.classList.add('loadout-tab--active');
        if (description && loadouts[loadoutKey]) {
          description.textContent = loadouts[loadoutKey].description;
        }
      } else {
        tab.classList.remove('loadout-tab--active');
      }
    });

    // Show/hide sections for initial loadout
    updateSkillSections(savedLoadout);

    // Add click handlers
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const loadoutKey = tab.getAttribute('data-loadout');

        // Update active state
        tabs.forEach(t => t.classList.remove('loadout-tab--active'));
        tab.classList.add('loadout-tab--active');

        // Update description
        if (description && loadouts[loadoutKey]) {
          description.textContent = loadouts[loadoutKey].description;
        }

        // Update visible skill sections
        updateSkillSections(loadoutKey);

        // Save to localStorage
        localStorage.setItem(STORAGE_KEY, loadoutKey);
      });
    });
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', initLoadoutSystem);
  // Also run immediately for Astro page transitions
  initLoadoutSystem();
</script>
