---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import skillsData from '../data/skills.json';

// Ensure base URL ends with a slash
const baseRaw = import.meta.env.BASE_URL;
const base = baseRaw.endsWith('/') ? baseRaw : `${baseRaw}/`;
const { loadouts, skills } = skillsData;
---

<BaseLayout title="Skill Gems">
  <Navigation slot="header" />

  <!-- Loadout-themed background overlay -->
  <div id="loadout-background" class="loadout-background"></div>

  <section class="page-header">
    <div class="container">
      <h1>Skill Gems</h1>
      <p class="text-muted">
        Gem links, support priorities, and alternative setups
      </p>
    </div>
  </section>

  <section class="skills-content section">
    <div class="container">

      <!-- Loadout Selector -->
      <div class="loadout-selector">
        <div class="loadout-header">
          <h3 class="loadout-title">Loadout</h3>
        </div>

        <div class="loadout-tabs" id="loadout-tabs">
          {Object.entries(loadouts).map(([key, loadout], index) => (
            <button
              class:list={['loadout-tab', { 'loadout-tab--active': index === 0 }]}
              data-loadout={key}
              title={loadout.description}
            >
              {loadout.name}
            </button>
          ))}
        </div>

        <p class="loadout-description" id="loadout-description">
          {Object.values(loadouts)[0]?.description}
        </p>

        <!-- Progression Dropdown (below tabs) -->
        <div class="progression-selector">
          <div class="progression-left">
            <label for="progression-dropdown" class="progression-label">Progression:</label>
            <select id="progression-dropdown" class="progression-dropdown">
              <!-- Populated by JavaScript based on selected loadout -->
            </select>
          </div>

          <!-- PoB Link (per progression) - always visible, aligned right -->
          <div class="pob-link-container" id="pob-link-container">
            <span class="pob-label">PoB:</span>
            <a href="#" id="pob-link" class="pob-link" target="_blank" rel="noopener noreferrer">
              123
            </a>
          </div>
        </div>
      </div>

      <!-- Passive Skill Tree Box -->
      <div class="passive-tree-box" id="passive-tree-box">
        <h3 class="passive-tree-title">Passive Skill Tree</h3>
        <div class="passive-tree-actions">
          <a href="#" id="open-planner-btn" class="btn-planner" target="_blank" rel="noopener noreferrer">
            Open in Planner
          </a>
          <button type="button" id="copy-tree-btn" class="btn-copy-tree">
            Copy Data
          </button>
        </div>
        <p class="passive-tree-note" id="passive-tree-note"></p>
      </div>

      <!-- Dynamic Skill Setups Container -->
      <div id="skill-setups-container">
        <!-- Skill setups will be dynamically rendered here -->
      </div>

    </div>
  </section>
</BaseLayout>

<style>
  /* Loadout-themed page background */
  .loadout-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s ease;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .loadout-background--active {
    opacity: 0.08;
  }

  /* Blend with dark theme */
  .loadout-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      180deg,
      var(--color-bg) 0%,
      transparent 20%,
      transparent 80%,
      var(--color-bg) 100%
    );
  }

  .loadout-selector {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.25s ease;
  }

  .loadout-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
  }

  .loadout-title {
    font-size: 1rem;
    color: var(--color-text-muted);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .progression-selector {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);
  }

  .progression-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .progression-label {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  /* PoB Link - always visible, aligned right */
  .pob-link-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.85rem;
  }

  .pob-label {
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .pob-link {
    color: var(--color-accent);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .pob-link:hover {
    color: var(--color-text);
    text-decoration: underline;
  }

  .progression-dropdown {
    padding: 0.4rem 0.8rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 120px;
  }

  .progression-dropdown:hover {
    border-color: var(--color-accent);
  }

  .progression-dropdown:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 2px var(--color-accent-glow);
  }

  .loadout-tabs {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-sm);
  }

  .loadout-tab {
    padding: 0.6rem 1.2rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text-muted);
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  /* Default tab hover - NOT applied to limited event tabs */
  .loadout-tab:not(.loadout-tab--limited-event):hover {
    border-color: var(--color-accent);
    color: var(--color-text);
  }

  .loadout-tab--active {
    background: var(--color-accent-glow);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .loadout-description {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-style: italic;
    margin: 0;
  }

  /* Passive Skill Tree Box */
  .passive-tree-box {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.25s ease;
  }

  .passive-tree-box:hover {
    border-color: var(--color-border-hover);
    box-shadow: var(--shadow-md);
  }

  .passive-tree-title {
    font-size: 1.1rem;
    color: var(--color-text);
    margin-bottom: var(--spacing-md);
  }

  .passive-tree-actions {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  .btn-planner {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.7rem 1.4rem;
    background: linear-gradient(135deg, #0d9488, #14b8a6);
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3);
  }

  .btn-planner:hover {
    background: linear-gradient(135deg, #0f766e, #0d9488);
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 6px 20px rgba(13, 148, 136, 0.45);
  }

  .btn-planner:active {
    transform: translateY(-1px) scale(1.01);
    box-shadow: 0 3px 12px rgba(13, 148, 136, 0.35);
  }

  .btn-copy-tree {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.7rem 1.4rem;
    background: var(--color-bg);
    color: var(--color-text);
    font-weight: 500;
    font-size: 0.9rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-copy-tree:hover {
    border-color: var(--color-accent);
    background: var(--color-bg-secondary);
  }

  .btn-copy-tree:active {
    transform: scale(0.98);
  }

  .btn-copy-tree.copied {
    background: rgba(34, 197, 94, 0.15);
    border-color: #22c55e;
    color: #22c55e;
  }

  .passive-tree-note {
    margin-top: var(--spacing-sm);
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .page-header {
    padding: var(--spacing-xl) 0;
    background: var(--color-bg-secondary);
    text-align: center;
    transition: background-color var(--transition-theme);
  }

  .page-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .skills-content {
    padding-bottom: var(--spacing-xl);
  }

  /* Skill section styles for dynamically generated content */
  :global(.skill-section) {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.25s ease;
  }

  :global(.skill-section:hover) {
    border-color: var(--color-border-hover);
    box-shadow: var(--shadow-md);
  }

  :global(.skill-section h2) {
    margin-bottom: var(--spacing-xs);
    font-size: 1.25rem;
  }

  :global(.section-desc) {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: var(--spacing-lg);
  }

  :global(.gem-setup) {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  :global(.gem-setup--6link) {
    background: var(--color-bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    border: 1px dashed var(--color-border);
  }

  :global(.gem-row) {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  /* Aura-specific layout - consistent icon sizing */
  :global(.gem-setup:not(.gem-setup--6link) .gem-row) {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 100px));
    justify-content: center;
    gap: var(--spacing-lg);
  }

  :global(.link-indicator) {
    color: var(--color-text-subtle);
    font-size: 0.9rem;
    font-weight: 400;
    letter-spacing: -2px;
    opacity: 0.6;
    user-select: none;
    /* Align link indicator with center of gem icon */
    margin-top: 24px;
  }

  /* Gem icon styles for dynamically generated content */
  :global(.gem-icon) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-align: center;
  }

  :global(.gem-icon-wrapper) {
    position: relative;
    width: 48px;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--color-border);
    background: var(--color-bg-secondary);
    transition: all 0.2s ease;
  }

  :global(.gem-icon-wrapper--main) {
    border: 3px solid var(--gem-color);
    box-shadow:
      0 0 12px color-mix(in srgb, var(--gem-color) 50%, transparent),
      inset 0 0 8px color-mix(in srgb, var(--gem-color) 20%, transparent);
  }

  :global(.gem-icon-wrapper--main:hover) {
    box-shadow:
      0 0 18px color-mix(in srgb, var(--gem-color) 70%, transparent),
      inset 0 0 12px color-mix(in srgb, var(--gem-color) 30%, transparent);
  }

  /* Support gem styling - icon only, no border/background */
  :global(.gem-icon-wrapper--support) {
    background: transparent;
    border: none;
    border-radius: 0;
    box-shadow: none;
    overflow: visible;
  }

  :global(.gem-icon-wrapper--support:hover) {
    background: transparent;
    border: none;
    box-shadow: none;
  }

  :global(.gem-icon-wrapper img) {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  :global(.gem-level) {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 1px 4px;
    border-radius: 3px;
    line-height: 1;
  }

  :global(.gem-level--warning) {
    background: var(--color-warning);
    color: black;
  }

  :global(.gem-name) {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    max-width: 80px;
    line-height: 1.2;
  }

  :global(.gem-name--support) {
    color: var(--color-text-subtle);
  }

  /* Transfigured Gem effect - renders INLINE with base skill name */
  /* Default: Fire/Orange gradient (SCAVENGING style) */
  :global(.gem-transfigured) {
    display: inline;
    font-size: inherit;
    font-weight: 600;
    margin-left: 0.25em;
    background: repeating-linear-gradient(
      90deg,
      #1a0a00 0%,
      #ff4500 12.5%,
      #ff6a00 25%,
      #cc3300 37.5%,
      #ff8c00 50%,
      #e65c00 62.5%,
      #ff4500 75%,
      #cc3300 87.5%,
      #1a0a00 100%
    );
    background-size: 200px 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gem-transfigured-flow 3s linear infinite;
  }

  /* PELTING - Blue/Ice gradient (overrides default) */
  :global(.gem-transfigured--pelting) {
    background: repeating-linear-gradient(
      90deg,
      #0a0a1a 0%,
      #4169e1 12.5%,
      #6495ed 25%,
      #1e90ff 37.5%,
      #87ceeb 50%,
      #4682b4 62.5%,
      #4169e1 75%,
      #1e90ff 87.5%,
      #0a0a1a 100%
    );
    background-size: 200px 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* VOLLEYS - Green/Emerald gradient (dexterity theme) */
  :global(.gem-transfigured--volleys) {
    background: repeating-linear-gradient(
      90deg,
      #001a0a 0%,
      #00ff7f 12.5%,
      #32cd32 25%,
      #228b22 37.5%,
      #7fff00 50%,
      #00fa9a 62.5%,
      #00ff7f 75%,
      #32cd32 87.5%,
      #001a0a 100%
    );
    background-size: 200px 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* COMBUSTING - Yellow/Amber gradient (burning theme) */
  :global(.gem-transfigured--combusting) {
    background: repeating-linear-gradient(
      90deg,
      #1a1a00 0%,
      #ffd700 12.5%,
      #ffb800 25%,
      #ff8c00 37.5%,
      #ffe066 50%,
      #ffcc00 62.5%,
      #ffd700 75%,
      #ff9900 87.5%,
      #1a1a00 100%
    );
    background-size: 200px 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  @keyframes gem-transfigured-flow {
    0% { background-position: 0 0; }
    100% { background-position: 200px 0; }
  }

  :global(.gem-icon:hover .gem-transfigured) {
    filter: brightness(1.3);
  }

  @media (max-width: 600px) {
    .loadout-header {
      flex-direction: column;
      align-items: flex-start;
    }

    :global(.gem-row) {
      gap: var(--spacing-sm);
    }

    :global(.link-indicator) {
      display: none;
    }
  }

  /* ===========================================
     EXPERIMENTAL: Gear Stat Image Hover Tooltip
     This is a TEST feature - easy to remove
     Delete this entire section to remove feature
     =========================================== */
  :global(.gear-hover-trigger) {
    position: relative;
    cursor: pointer;
  }

  :global(.gear-hover-tooltip) {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  :global(.gear-hover-trigger:hover .gear-hover-tooltip) {
    opacity: 1;
    visibility: visible;
  }

  :global(.gear-hover-tooltip img) {
    max-width: 300px;
    max-height: 400px;
    border-radius: var(--radius-md);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--color-border);
  }

  :global(.gear-hover-tooltip::after) {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--color-border);
  }
  /* END EXPERIMENTAL FEATURE */
</style>

<script define:vars={{ loadouts, skills, base }}>
  // Storage keys for persistence
  const STORAGE_KEY_LOADOUT = 'emiracle-cws-loadout';
  const STORAGE_KEY_PROGRESSIONS = 'emiracle-cws-progressions';

  let currentLoadout = 'default';
  let currentProgression = null;

  // Get saved progressions per loadout
  function getSavedProgressions() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESSIONS) || '{}');
    } catch {
      return {};
    }
  }

  // Save progression for current loadout
  function saveProgression(loadoutKey, progressionKey) {
    const saved = getSavedProgressions();
    saved[loadoutKey] = progressionKey;
    localStorage.setItem(STORAGE_KEY_PROGRESSIONS, JSON.stringify(saved));
  }

  // Get skill icon URL
  function getSkillIconUrl(skillId) {
    const skill = skills[skillId];
    if (!skill || !skill.icon) return '';
    return `${base}${skill.icon.replace(/^\//, '')}`;
  }

  // Check if skill has "main" tag
  function hasMainTag(skillId) {
    const skill = skills[skillId];
    if (!skill || !skill.tags) return false;
    return skill.tags.some(tag => tag === 'main');
  }

  // Get structured tags (objects with prefix/name) for animated effects
  function getStructuredTags(skillId) {
    const skill = skills[skillId];
    if (!skill || !skill.tags) return [];
    return skill.tags.filter(tag => typeof tag === 'object' && tag.prefix && tag.name);
  }

  // Color map for gem border colors
  const colorMap = {
    red: '#c41e3a',    // Strength gems
    green: '#1eff00',  // Dexterity gems
    blue: '#4169e1',   // Intelligence gems
    white: '#e0e0e0',  // Support gems
  };

  // Update loadout-themed page background
  function updateLoadoutBackground(loadoutKey) {
    const bgElement = document.getElementById('loadout-background');
    if (!bgElement) return;

    const loadout = loadouts[loadoutKey];
    const bgImage = loadout?.background;

    if (bgImage) {
      // Build full URL for background image
      const bgUrl = `${base}${bgImage.replace(/^\//, '')}`;
      bgElement.style.backgroundImage = `url('${bgUrl}')`;
      bgElement.classList.add('loadout-background--active');
    } else {
      // Remove background for loadouts without themed background
      bgElement.classList.remove('loadout-background--active');
      // Clear image after fade out
      setTimeout(() => {
        if (!bgElement.classList.contains('loadout-background--active')) {
          bgElement.style.backgroundImage = '';
        }
      }, 500);
    }
  }

  // Render a single gem icon
  function renderGemIcon(skillId) {
    const skill = skills[skillId];
    if (!skill) return '';

    const iconUrl = getSkillIconUrl(skillId);
    const isMain = hasMainTag(skillId);
    const isSupport = skill.isSupport;
    const level = skill.level || 20;
    const levelWarning = skill.levelWarning;
    const structuredTags = getStructuredTags(skillId);
    const gemColor = colorMap[skill.color] || colorMap.blue;

    // Build transfigured gem HTML with animated effect (renders INLINE with base name)
    // Each suffix/prefix gets a unique color class based on name
    const transfiguredHtml = structuredTags.map(tag => {
      const colorClass = `gem-transfigured--${tag.name.toLowerCase()}`;
      return `<span class="gem-transfigured ${colorClass}">${tag.prefix} ${tag.name}</span>`;
    }).join('');

    // Level display: only show when there's a warning (otherwise assumed max level)
    const levelHtml = levelWarning ? `<span class="gem-level gem-level--warning">!${level}</span>` : '';

    // Build wrapper classes
    let wrapperClasses = 'gem-icon-wrapper';
    if (isMain) wrapperClasses += ' gem-icon-wrapper--main';
    if (isSupport) wrapperClasses += ' gem-icon-wrapper--support';

    return `
      <div class="gem-icon">
        <div class="${wrapperClasses}" style="--gem-color: ${gemColor}">
          ${iconUrl ? `<img src="${iconUrl}" alt="${skill.baseName}" loading="lazy">` : ''}
          ${levelHtml}
        </div>
        <span class="gem-name${isSupport ? ' gem-name--support' : ''}">${skill.baseName}${transfiguredHtml}</span>
      </div>
    `;
  }

  // Render skill setups for the current loadout and progression
  function renderSkillSetups(loadoutKey, progressionKey) {
    const container = document.getElementById('skill-setups-container');
    if (!container) return;

    const loadout = loadouts[loadoutKey];
    if (!loadout || !loadout.progressions) {
      container.innerHTML = '<p class="text-muted">No skill setups available.</p>';
      return;
    }

    const progression = loadout.progressions[progressionKey];
    if (!progression || !progression.skillSetups) {
      container.innerHTML = '<p class="text-muted">No skill setups for this progression.</p>';
      return;
    }

    let html = '';

    // Render each skill setup in the progression
    Object.entries(progression.skillSetups).forEach(([setupId, setup]) => {
      const isLinked = setup.isLinked;

      html += `
        <div class="skill-section" data-setup-id="${setupId}">
          <h2>${setup.title}</h2>
          <p class="section-desc">${setup.description}</p>
          <div class="gem-setup${isLinked ? ' gem-setup--6link' : ''}">
      `;

      // Render each row
      setup.rows.forEach(row => {
        html += '<div class="gem-row">';

        row.forEach((item, itemIndex) => {
          // Add link indicator between gems in linked setups
          if (isLinked && itemIndex > 0) {
            html += '<span class="link-indicator">───</span>';
          }
          html += renderGemIcon(item.skillId);
        });

        html += '</div>';
      });

      html += '</div></div>';
    });

    container.innerHTML = html;
  }

  // Populate progression dropdown for the selected loadout
  function populateProgressionDropdown(loadoutKey) {
    const dropdown = document.getElementById('progression-dropdown');
    if (!dropdown) return;

    const loadout = loadouts[loadoutKey];
    if (!loadout || !loadout.progressions) {
      dropdown.innerHTML = '<option value="">No progressions</option>';
      return;
    }

    // Get saved progression for this loadout, or use default
    const savedProgressions = getSavedProgressions();
    const savedProgression = savedProgressions[loadoutKey] || loadout.defaultProgression;

    // Clear and populate dropdown
    dropdown.innerHTML = '';

    Object.entries(loadout.progressions).forEach(([key, progression]) => {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = progression.name;

      if (key === savedProgression) {
        option.selected = true;
        currentProgression = key;
      }

      dropdown.appendChild(option);
    });

    // If no saved progression matched, select the first one
    if (!currentProgression && dropdown.options.length > 0) {
      currentProgression = dropdown.options[0].value;
      dropdown.options[0].selected = true;
    }
  }

  // Handle progression change
  function handleProgressionChange() {
    const dropdown = document.getElementById('progression-dropdown');
    if (!dropdown) return;

    currentProgression = dropdown.value;
    saveProgression(currentLoadout, currentProgression);
    renderSkillSetups(currentLoadout, currentProgression);
    updatePassiveTreeBox(currentLoadout, currentProgression);
    updatePobLink(currentLoadout, currentProgression);
  }

  // Update PoB link based on current loadout and progression
  // Always visible, updates value per progression
  function updatePobLink(loadoutKey, progressionKey) {
    const link = document.getElementById('pob-link');

    if (!link) return;

    const loadout = loadouts[loadoutKey];
    const progression = loadout?.progressions?.[progressionKey];
    const pobLink = progression?.pobLink;

    // Use pobLink if available, otherwise show placeholder
    if (pobLink && pobLink.trim() !== '') {
      link.href = pobLink;
      link.textContent = 'View';
    } else {
      link.href = '#';
      link.textContent = '123';
    }
  }

  // Update passive tree box based on current loadout and progression
  function updatePassiveTreeBox(loadoutKey, progressionKey) {
    const plannerBtn = document.getElementById('open-planner-btn');
    const copyBtn = document.getElementById('copy-tree-btn');
    const note = document.getElementById('passive-tree-note');

    if (!plannerBtn || !copyBtn) return;

    const loadout = loadouts[loadoutKey];
    const progression = loadout?.progressions?.[progressionKey];
    const treeData = progression?.passiveTree;

    if (treeData && treeData.plannerUrl) {
      plannerBtn.href = treeData.plannerUrl;
      plannerBtn.style.pointerEvents = 'auto';
      plannerBtn.style.opacity = '1';
    } else {
      plannerBtn.href = '#';
      plannerBtn.style.pointerEvents = 'none';
      plannerBtn.style.opacity = '0.5';
    }

    // Update note
    if (note) {
      if (!treeData?.treeData) {
        note.textContent = 'Tree data not yet available for this progression.';
      } else {
        note.textContent = '';
      }
    }

    // Store tree data on button for copy functionality
    copyBtn.dataset.treeData = treeData?.treeData || '';
  }

  // Handle copy tree data
  function handleCopyTreeData() {
    const copyBtn = document.getElementById('copy-tree-btn');
    if (!copyBtn) return;

    const treeData = copyBtn.dataset.treeData;

    if (!treeData) {
      // Show temporary "No data" message
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'No Data';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 1500);
      return;
    }

    navigator.clipboard.writeText(treeData).then(() => {
      // Show success state
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      copyBtn.classList.add('copied');
      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.classList.remove('copied');
      }, 1500);
    }).catch(() => {
      // Fallback for older browsers
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Failed';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 1500);
    });
  }

  // Initialize the loadout system
  function initLoadoutSystem() {
    const tabs = document.querySelectorAll('.loadout-tab');
    const description = document.getElementById('loadout-description');
    const progressionDropdown = document.getElementById('progression-dropdown');

    // Load saved loadout
    const savedLoadout = localStorage.getItem(STORAGE_KEY_LOADOUT) || 'default';
    currentLoadout = savedLoadout;

    // Set initial active tab and description
    tabs.forEach(tab => {
      const loadoutKey = tab.getAttribute('data-loadout');
      if (loadoutKey === savedLoadout) {
        tab.classList.add('loadout-tab--active');
        if (description && loadouts[loadoutKey]) {
          description.textContent = loadouts[loadoutKey].description;
        }
      } else {
        tab.classList.remove('loadout-tab--active');
      }
    });

    // Populate progression dropdown for initial loadout
    populateProgressionDropdown(savedLoadout);

    // Render skill setups for initial loadout and progression
    renderSkillSetups(currentLoadout, currentProgression);

    // Update passive tree box
    updatePassiveTreeBox(currentLoadout, currentProgression);

    // Update PoB link
    updatePobLink(currentLoadout, currentProgression);

    // Update loadout-themed background
    updateLoadoutBackground(currentLoadout);

    // Add progression dropdown change handler
    if (progressionDropdown) {
      progressionDropdown.addEventListener('change', handleProgressionChange);
    }

    // Add copy tree button handler
    const copyBtn = document.getElementById('copy-tree-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', handleCopyTreeData);
    }

    // Add loadout tab click handlers
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const loadoutKey = tab.getAttribute('data-loadout');
        currentLoadout = loadoutKey;

        // Update active state
        tabs.forEach(t => t.classList.remove('loadout-tab--active'));
        tab.classList.add('loadout-tab--active');

        // Update description
        if (description && loadouts[loadoutKey]) {
          description.textContent = loadouts[loadoutKey].description;
        }

        // Populate progression dropdown for this loadout
        populateProgressionDropdown(loadoutKey);

        // Render skill setups for this loadout and progression
        renderSkillSetups(loadoutKey, currentProgression);

        // Update passive tree box
        updatePassiveTreeBox(loadoutKey, currentProgression);

        // Update PoB link
        updatePobLink(loadoutKey, currentProgression);

        // Update loadout-themed background
        updateLoadoutBackground(loadoutKey);

        // Save loadout
        localStorage.setItem(STORAGE_KEY_LOADOUT, loadoutKey);
      });
    });
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', initLoadoutSystem);
  // Also run immediately for Astro page transitions
  initLoadoutSystem();
</script>
