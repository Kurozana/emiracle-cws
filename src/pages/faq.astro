---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import SocialLinks from '../components/SocialLinks.astro';

// FAQ Categories and Questions
const faqCategories = [
  {
    id: 'getting-started',
    name: 'Getting Started',
    questions: [
      {
        faqId: 'FAQ001',
        q: 'How can I...? What...? Where...?',
        a: 'Search your question before asking. 99% of questions have already been answered. Always refer to:\n1) Video guide\n2) Google doc\n3) FAQ\n4) Search\n5) Ask\n\nIt\'s alright to ask, just make sure you do so when you actually can\'t find the answer.'
      },
      {
        faqId: 'FAQ002',
        q: 'What are the viable starters?',
        a: 'Refer to video guide'
      },
      {
        faqId: 'FAQ003',
        q: 'When can I swap to CWS? Minimum gear/Level/Ascendancy points/etc?',
        a: 'Refer to video guide'
      },
      {
        faqId: 'FAQ014',
        q: 'What are the best leveling uniques or items for this build?',
        a: 'Refer to starter build guide'
      },
      {
        faqId: 'FAQ016',
        q: 'Bandit strategy?',
        a: 'Take what you want early, respec later to kill all'
      },
      {
        faqId: 'FAQ032',
        q: 'What gems should I level in off-hand during campaign?',
        a: 'CWS and Petrified Blood'
      },
      {
        faqId: 'FAQ033',
        q: 'How do I get 4 voidstone completion?',
        a: 'Refer to starter build guide'
      },
    ]
  },
  {
    id: 'gear-requirements',
    name: 'Gear & Requirements',
    questions: [
      {
        faqId: 'FAQ004',
        q: 'What % Bloodnotch do I need?',
        a: 'At least 50%'
      },
      {
        faqId: 'FAQ005',
        q: 'What % Immutable Force do I need?',
        a: 'Any roll is fine, but everything under 961% is the same (2 server ticks vs 1 server tick). See Reddit thread for breakpoints.'
      },
      {
        faqId: 'FAQ006',
        q: 'How much recoup do I need?',
        a: '20-30%. 30%+ is most comfortable. 20% is serviceable but not recommended. Get it on jewels/tree.'
      },
      {
        faqId: 'FAQ007',
        q: 'Which ignite prolif should I use?',
        a: 'Gloves can replace Fan the Flames, but it may be expensive. You only need one source.'
      },
      {
        faqId: 'FAQ013',
        q: 'Does gain 1/2/3 charges make a big difference on flasks?',
        a: '1: usually too little\n2: acceptable\n3: best option'
      },
      {
        faqId: 'FAQ021',
        q: 'Rise of the Phoenix vs Dawnbreaker vs Prism Guardian vs Crafted Shield?',
        a: 'Refer to progression guide'
      },
      {
        faqId: 'FAQ022',
        q: 'Do bases matter for Gloves / Helm / Boots?',
        a: 'Avoid pure evasion or ES bases. Armor is acceptable but low impact. Other bases are downgrades.'
      },
      {
        faqId: 'FAQ031',
        q: 'What item filter should I use?',
        a: 'No all-in-one filter; you must prepare your own'
      },
      {
        faqId: 'FAQ039',
        q: 'What anoint should I use?',
        a: 'Cheap: any life node\nExpensive: Defiled Forces'
      },
      {
        faqId: 'FAQ042',
        q: 'Mageblood?',
        a: 'Only after all other upgrades. Very marginal benefit.'
      },
    ]
  },
  {
    id: 'mechanics',
    name: 'Build Mechanics',
    questions: [
      {
        faqId: 'FAQ008',
        q: 'Why no Svalinn or block-based CWS?',
        a: 'Bloodnotch already functions as near-100% block against non-one-shots. Adding Svalinn reduces max hit and shield value, increasing one-shot vulnerability.'
      },
      {
        faqId: 'FAQ010',
        q: 'Why am I not getting stunned / not proccing my skills?',
        a: 'Check the following:\n- Pantheon cannot be Brine King\n- CWS should be 20/20 or close\n- Low max ES\n- Low evasion\n- Valyrium must be equipped'
      },
      {
        faqId: 'FAQ017',
        q: 'Do I need 100% ignite chance?',
        a: 'Yes'
      },
      {
        faqId: 'FAQ018',
        q: 'Can I still run Fire Trap for single target?',
        a: 'No, it is redundant. Hinekora ignites are sufficient even for Wave 15 Omni.'
      },
      {
        faqId: 'FAQ019',
        q: 'What is the minimum STR / INT / DEX I need?',
        a: 'STR: covered by pathing\nDEX: ~100 (hard to get)\nINT: ~150 (may require affixes)'
      },
      {
        faqId: 'FAQ020',
        q: 'How do I get full ailment immunity?',
        a: 'We do not get full immunity; it is handled via flasks'
      },
      {
        faqId: 'FAQ023',
        q: 'How do I generate endurance charges?',
        a: 'Budget: Inexorable node\nExpensive: Unflinching Flesh and Flame'
      },
      {
        faqId: 'FAQ024',
        q: 'How do I get max resistances?',
        a: 'Passive points, jewels, Purity of Fire level 21, implicits'
      },
      {
        faqId: 'FAQ037',
        q: 'How does Hateful Accuser work?',
        a: 'It summons small monsters that are killed with RF and popped via Hinekora.'
      },
      {
        faqId: 'FAQ040',
        q: 'How much crit mitigation do I need?',
        a: 'Stun mastery is sufficient'
      },
      {
        faqId: 'FAQ044',
        q: 'Do I need 155 DEX for Bladefall?',
        a: 'No. Damage does not matter; it is used for hit frequency.'
      },
      {
        faqId: 'FAQ045',
        q: 'Gem quality priority?',
        a: 'Petrified Blood > Cast When Stunned > everything else'
      },
      {
        faqId: 'FAQ051',
        q: 'Why Dark Seer?',
        a: 'High life, 10% increased damage dealt, 10% reduced damage taken'
      },
      {
        faqId: 'FAQ052',
        q: 'Do triggered curses refresh ignites?',
        a: 'No'
      },
      {
        faqId: 'FAQ054',
        q: 'Does Wellspring of Creation increase DD damage?',
        a: 'No'
      },
      {
        faqId: 'FAQ055',
        q: 'Why do we use Bladefall / Frost Bomb?',
        a: 'Bladefall procs Wrapped in Flame and life on hit\nFrost Bomb reduces enemy life regeneration by 75%'
      },
      {
        faqId: 'FAQ056',
        q: 'Where do we get ignite chance from?',
        a: 'Sources:\n- Ignite tattoos\n- Blowback cluster node\n- Rare jewel suffix\n- Early flask suffix if needed'
      },
      {
        faqId: 'FAQ059',
        q: 'How to deal with reflect?',
        a: 'Hinekora pops cannot be reflected. Keep non-DD / non-Unearth gems low level.'
      },
      {
        faqId: 'FAQ038',
        q: 'What are alternative gems for the 6-link?',
        a: 'Refer to guide'
      },
    ]
  },
  {
    id: 'mapping',
    name: 'Mapping & Atlas',
    questions: [
      {
        faqId: 'FAQ025',
        q: 'What league mechanics are good for the build?',
        a: 'Good mechanics:\n- Ultimatum\n- Expedition\n- Harbingers\n- Ritual\n- Beyond\n- Simulacrum (with good gear)'
      },
      {
        faqId: 'FAQ028',
        q: 'What map mods do I avoid early mapping?',
        a: 'Avoid:\n- No regen\n- Minus max res\n- Any 2+ damage mod combination'
      },
      {
        faqId: 'FAQ029',
        q: 'What map mods do I avoid late game T16 mapping?',
        a: 'Refer to doc'
      },
      {
        faqId: 'FAQ030',
        q: 'What map mods do I avoid late game T17 mapping?',
        a: 'Refer to doc'
      },
      {
        faqId: 'FAQ046',
        q: 'If I run Ultimatum strat, how do I sustain maps?',
        a: 'You don\'t. You must buy them.'
      },
      {
        faqId: 'FAQ047',
        q: 'Do map mods affect Ultimatum rewards?',
        a: 'They affect catalyst quantity and post-Ultimatum loot, not offered rewards.'
      },
      {
        faqId: 'FAQ048',
        q: 'What map to run (< T17)?',
        a: 'Any map you can navigate comfortably'
      },
      {
        faqId: 'FAQ049',
        q: 'What map to run (T17)?',
        a: 'Abomination'
      },
    ]
  },
  {
    id: 'ultimatum',
    name: 'Ultimatum Strategy',
    questions: [
      {
        faqId: 'FAQ026',
        q: 'What\'s the difference between T7 / T10 / T16 / T17 Ultimatum?',
        a: 'Range, quality, and quantity change. Exact numbers unknown.'
      },
      {
        faqId: 'FAQ027',
        q: 'What Ultimatum mods do I run / avoid?',
        a: 'Refer to doc'
      },
    ]
  },
  {
    id: 'endgame',
    name: 'Endgame & Bossing',
    questions: [
      {
        faqId: 'FAQ011',
        q: 'What is the minimum gear/level needed for Wave 10/15 Simulacrum?',
        a: 'Refer to doc'
      },
      {
        faqId: 'FAQ012',
        q: 'How do I maximize my single target damage?',
        a: 'Tips:\n- 100% generic ignite chance\n- Spam Penance Mark\n- Use Vaal Breach\n- Scale AoE so more explosions hit the boss'
      },
      {
        faqId: 'FAQ034',
        q: 'Are there good Mercenary setups for the build?',
        a: 'No. Mercenaries die often and provide no worthwhile value.'
      },
      {
        faqId: 'FAQ036',
        q: 'Is it worth running Animate Guardian?',
        a: 'No. AG dies often and steals aggro, reducing triggers.'
      },
      {
        faqId: 'FAQ041',
        q: 'Can I do T17s?',
        a: 'Depends; refer to progression guide'
      },
      {
        faqId: 'FAQ050',
        q: 'How to kill Abomination boss?',
        a: 'Kill order:\n1) Kill Maligaro first\n2) Then Shavronne\n3) Doedre last\n\nNote: Doedre early creates damage-reducing pillars'
      },
      {
        faqId: 'FAQ053',
        q: 'Can you farm Valdo maps with Chieftain?',
        a: 'Some easy ones, but it is not recommended. PF CWS works better but is expensive.'
      },
      {
        faqId: 'FAQ057',
        q: 'When should I swap to the Svalinn / block version?',
        a: 'Only for extreme gauntlet-style atlas content'
      },
      {
        faqId: 'FAQ060',
        q: 'How to kill Kosis if he is alone?',
        a: 'Strategy:\n- Kite into packs\n- Prolif ignites\n- Refresh with Penance Mark\n- Fish for Hinekora pop if AoE allows'
      },
      {
        faqId: 'FAQ061',
        q: 'How to get more damage?',
        a: 'Damage scaling:\n- Scale gem levels and quality\n- Use awakened gems\n- Jewels with 3 damage mods\n- AoE clusters'
      },
    ]
  },
  {
    id: 'progression',
    name: 'Progression & Upgrades',
    questions: [
      {
        faqId: 'FAQ009',
        q: 'Where is PoB for Ruin?',
        a: 'Updated on the Google sheet in the CWS 2.0 page'
      },
      {
        faqId: 'FAQ015',
        q: 'What Pantheons are best for this build and why?',
        a: 'Major: Lunaris + 6% reduced elemental damage taken\nMinor: Upgraded Tukohama'
      },
      {
        faqId: 'FAQ043',
        q: 'What was buffed / nerfed in 3.26?',
        a: 'Flasks triggering in Trialmaster fight (major buff)'
      },
      {
        faqId: 'FAQ058',
        q: 'What\'s my next build upgrade?',
        a: 'Refer to build sheets and PoBs. Choose based on content goals.'
      },
    ]
  },
  {
    id: 'troubleshooting',
    name: 'Troubleshooting',
    questions: [
      {
        faqId: 'FAQ035',
        q: 'Why do I die? (Checklist)',
        a: 'Checklist:\n- 6.5k+ total life\n- Chaos res capped\n- 90% elemental res\n- Auras active\n- 55%+ unreserved life\n- Avoid stacking damage mods\n- Read Ultimatum mods\n- Correct pantheon\n- Correct tree'
      },
    ]
  },
  {
    id: 'community',
    name: 'Community & Resources',
    questions: [
      {
        faqId: 'FAQ-SOCIAL',
        q: "Where can I find Emiracles' streams?",
        a: 'social-links' // Special flag to render social links
      },
      {
        faqId: 'FAQ-DISCORD',
        q: 'Is there a Discord community?',
        a: 'Yes! Join the community Discord to ask questions, share builds, and connect with other CWS players.'
      },
      {
        faqId: 'FAQ-ASK',
        q: 'Where can I ask questions about the build?',
        a: 'Use the Discord community or Twitch chat during streams. Remember to search first - most questions have already been answered!'
      },
    ]
  },
];
---

<BaseLayout title="FAQ">
  <Navigation slot="header" />

  <section class="page-header">
    <div class="container">
      <h1 class="animate-fade-in-up">Frequently Asked Questions</h1>
      <p class="text-muted animate-fade-in-up delay-100">
        Everything you need to know about the Cast When Stunned build
      </p>
    </div>
  </section>

  <!-- Category Navigation -->
  <section class="faq-nav">
    <div class="container">
      <div class="category-tabs">
        {faqCategories.map((category, index) => (
          <a
            href={`#${category.id}`}
            class="category-tab animate-fade-in-up"
            style={`animation-delay: ${index * 50}ms`}
          >
            <span class="category-name">{category.name}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- FAQ Content -->
  <section class="faq-content section">
    <div class="container">
      {faqCategories.map((category, catIndex) => (
        <div id={category.id} class="faq-category animate-fade-in-up" style={`animation-delay: ${catIndex * 100}ms`}>
          <h2 class="category-title">
            {category.name}
          </h2>

          <div class="faq-list">
            {category.questions.map((faq, qIndex) => (
              <details class="faq-item" id={faq.faqId}>
                <summary class="faq-question">
                  <span class="question-text">{faq.q}</span>
                  <span class="question-toggle"></span>
                </summary>
                <div class="faq-answer">
                  {faq.a === 'social-links' ? (
                    <div class="social-answer">
                      <p>Follow Emiracles on these platforms:</p>
                      <SocialLinks
                        discord="https://discord.gg/n6A9992BaD"
                        youtube="https://www.youtube.com/@HolyFkingShit"
                        twitch="https://www.twitch.tv/emiracles"
                        size="lg"
                        showLabels={true}
                      />
                    </div>
                  ) : (
                    <p class="answer-text">{faq.a}</p>
                  )}
                </div>
              </details>
            ))}
          </div>
        </div>
      ))}

      <!-- Still have questions? -->
      <div class="faq-cta animate-fade-in-up">
        <h3>Still have questions?</h3>
        <p class="text-muted">Join the community and ask directly!</p>
        <SocialLinks
          discord="https://discord.gg/n6A9992BaD"
          youtube="https://www.youtube.com/@HolyFkingShit"
          twitch="https://www.twitch.tv/emiracles"
          size="md"
          showLabels={true}
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    padding: var(--spacing-xl) 0;
    background: var(--color-bg-secondary);
    text-align: center;
  }

  .page-header h1 {
    color: var(--color-accent);
  }

  /* Category Navigation */
  .faq-nav {
    background: var(--color-bg-tertiary);
    padding: var(--spacing-lg) 0;
    position: sticky;
    top: 60px;
    z-index: 50;
    border-bottom: 1px solid var(--color-border);
  }

  .category-tabs {
    display: flex;
    gap: var(--spacing-sm);
    overflow-x: auto;
    padding-bottom: var(--spacing-sm);
    scrollbar-width: none;
  }

  .category-tabs::-webkit-scrollbar {
    display: none;
  }

  .category-tab {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: 0.75rem 1.25rem;
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    font-size: 0.9rem;
    white-space: nowrap;
    transition: all 0.25s ease;
  }

  .category-tab:hover {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background: var(--color-accent-glow);
    transform: translateY(-2px);
  }

  /* FAQ Categories */
  .faq-category {
    margin-bottom: var(--spacing-xl);
    padding-top: var(--spacing-lg);
  }

  .category-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
  }

  /* FAQ Items */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .faq-item {
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: all 0.25s ease;
  }

  .faq-item:hover {
    border-color: var(--color-border-hover);
  }

  .faq-item[open] {
    border-color: var(--color-accent);
    box-shadow: 0 4px 20px var(--color-accent-glow);
  }

  .faq-question {
    padding: var(--spacing-lg);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
    list-style: none;
    user-select: none;
  }

  .faq-question::-webkit-details-marker {
    display: none;
  }

  .question-text {
    font-weight: 500;
    font-size: 1.05rem;
    color: var(--color-text);
    transition: color 0.2s ease;
  }

  .faq-item:hover .question-text {
    color: var(--color-accent);
  }

  .question-toggle {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    position: relative;
    border: 2px solid var(--color-accent);
    border-radius: 50%;
    transition: all 0.25s ease;
  }

  .question-toggle::before,
  .question-toggle::after {
    content: '';
    position: absolute;
    background: var(--color-accent);
    transition: all 0.25s ease;
  }

  .question-toggle::before {
    width: 10px;
    height: 2px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .question-toggle::after {
    width: 2px;
    height: 10px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .faq-item[open] .question-toggle {
    background: var(--color-accent);
    transform: rotate(45deg);
  }

  .faq-item[open] .question-toggle::before,
  .faq-item[open] .question-toggle::after {
    background: var(--color-bg);
  }

  .faq-answer {
    padding: 0 var(--spacing-lg) var(--spacing-lg);
    color: var(--color-text-muted);
    line-height: 1.7;
    border-top: 1px solid var(--color-border);
    margin-top: -1px;
    padding-top: var(--spacing-lg);
    background: rgba(0, 0, 0, 0.2);
  }

  .answer-text {
    white-space: pre-line;
    margin: 0;
  }

  .social-answer {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .social-answer p {
    margin: 0;
  }

  /* CTA Section */
  .faq-cta {
    margin-top: var(--spacing-xl);
    padding: var(--spacing-xl);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-lg);
    text-align: center;
    border: 1px solid var(--color-border);
  }

  .faq-cta h3 {
    color: var(--color-accent);
    margin-bottom: var(--spacing-sm);
  }

  .faq-cta p {
    margin-bottom: var(--spacing-lg);
  }

  .faq-cta :global(.social-links) {
    justify-content: center;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .faq-nav {
      top: 0;
    }

    .category-tab {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .faq-question {
      padding: var(--spacing-md);
    }

    .question-text {
      font-size: 1rem;
    }
  }
</style>

<script>
  // Smooth scroll to category when clicking nav tabs
  document.querySelectorAll('.category-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = tab.getAttribute('href');
      const target = document.querySelector(targetId);
      if (target) {
        const navHeight = document.querySelector('.faq-nav')?.offsetHeight || 0;
        const targetPosition = target.getBoundingClientRect().top + window.scrollY - navHeight - 20;
        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
      }
    });
  });

  // Handle direct FAQ links (e.g., /faq#FAQ001)
  function scrollToFaq() {
    const hash = window.location.hash;
    if (hash && hash.startsWith('#FAQ')) {
      const faqItem = document.querySelector(hash);
      if (faqItem) {
        const navHeight = document.querySelector('.faq-nav')?.offsetHeight || 0;
        const targetPosition = faqItem.getBoundingClientRect().top + window.scrollY - navHeight - 20;
        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
        // Open the FAQ item
        if (faqItem instanceof HTMLDetailsElement) {
          faqItem.open = true;
        }
      }
    }
  }

  // Run on load and hash change
  window.addEventListener('load', scrollToFaq);
  window.addEventListener('hashchange', scrollToFaq);
</script>
